import streamlit as st
import pandas as pd
from io import StringIO

st.set_page_config(page_title="健康寿命シミュレーター", layout="centered")
st.title("個人向け 健康寿命シミュレーター")

# ===============================
# list.csv（TSV）埋め込み
# ===============================
LIST_TSV = """year,category,sex,BP,SM,DM,BMI
20.29,M1111,M,1,1,1,1
22.62,M1112,M,1,1,1,2
23.86,M1113,M,1,1,1,3
21.97,M1114,M,1,1,1,4
18.74,M1211,M,1,2,1,1
20.98,M1212,M,1,2,1,2
22.1,M1213,M,1,2,1,3
20.47,M1214,M,1,2,1,4
16.73,M1311,M,1,3,1,1
18.76,M1312,M,1,3,1,2
19.87,M1313,M,1,3,1,3
18.07,M1314,M,1,3,1,4
19.5,M2111,M,2,1,1,1
22.01,M2112,M,2,1,1,2
23.09,M2113,M,2,1,1,3
21.06,M2114,M,2,1,1,4
18.02,M2211,M,2,2,1,1
20.27,M2212,M,2,2,1,2
21.32,M2213,M,2,2,1,3
19.61,M2214,M,2,2,1,4
16.02,M2311,M,2,3,1,1
18.09,M2312,M,2,3,1,2
19.12,M2313,M,2,3,1,3
17.26,M2314,M,2,3,1,4
18.04,M3111,M,3,1,1,1
20.77,M3112,M,3,1,1,2
21.57,M3113,M,3,1,1,3
19.86,M3114,M,3,1,1,4
16.56,M3211,M,3,2,1,1
18.88,M3212,M,3,2,1,2
19.7,M3213,M,3,2,1,3
18.42,M3214,M,3,2,1,4
14.83,M3311,M,3,3,1,1
16.98,M3312,M,3,3,1,2
17.83,M3313,M,3,3,1,3
16.25,M3314,M,3,3,1,4
17.17,M4111,M,4,1,1,1
19.78,M4112,M,4,1,1,2
20.56,M4113,M,4,1,1,3
18.92,M4114,M,4,1,1,4
15.73,M4211,M,4,2,1,1
17.96,M4212,M,4,2,1,2
18.76,M4213,M,4,2,1,3
17.53,M4214,M,4,2,1,4
14.05,M4311,M,4,3,1,1
16.12,M4312,M,4,3,1,2
16.95,M4313,M,4,3,1,3
15.42,M4314,M,4,3,1,4
17.56,M1121,M,1,1,2,1
19.63,M1122,M,1,1,2,2
20.8,M1123,M,1,1,2,3
18.87,M1124,M,1,1,2,4
16.21,M1221,M,1,2,2,1
18.2,M1222,M,1,2,2,2
19.28,M1223,M,1,2,2,3
17.54,M1224,M,1,2,2,4
14.25,M1321,M,1,3,2,1
16.06,M1322,M,1,3,2,2
17.12,M1323,M,1,3,2,3
15.3,M1324,M,1,3,2,4
16.81,M2121,M,2,1,2,1
19.13,M2122,M,2,1,2,2
20.14,M2123,M,2,1,2,3
18.03,M2124,M,2,1,2,4
15.51,M2221,M,2,2,2,1
17.56,M2222,M,2,2,2,2
18.56,M2223,M,2,2,2,3
16.74,M2224,M,2,2,2,4
13.57,M2321,M,2,3,2,1
15.47,M2322,M,2,3,2,2
16.44,M2323,M,2,3,2,3
14.55,M2324,M,2,3,2,4
15.63,M3121,M,3,1,2,1
18.18,M3122,M,3,1,2,2
18.98,M3123,M,3,1,2,3
17.01,M3124,M,3,1,2,4
14.33,M3221,M,3,2,2,1
16.48,M3222,M,3,2,2,2
17.29,M3223,M,3,2,2,3
15.74,M3224,M,3,2,2,4
12.59,M3321,M,3,3,2,1
14.58,M3322,M,3,3,2,2
15.41,M3323,M,3,3,2,3
13.68,M3324,M,3,3,2,4
14.82,M4121,M,4,1,2,1
17.27,M4122,M,4,1,2,2
18.05,M4123,M,4,1,2,3
16.16,M4124,M,4,1,2,4
13.57,M4221,M,4,2,2,1
15.63,M4222,M,4,2,2,2
16.43,M4223,M,4,2,2,3
14.93,M4224,M,4,2,2,4
11.88,M4321,M,4,3,2,1
13.79,M4322,M,4,3,2,2
14.6,M4323,M,4,3,2,3
12.93,M4324,M,4,3,2,4
22.59,F1111,F,1,1,1,1
26.3,F1112,F,1,1,1,2
26.11,F1113,F,1,1,1,3
27.27,F1114,F,1,1,1,4
18.15,F1211,F,1,2,1,1
21.15,F1212,F,1,2,1,2
21.02,F1213,F,1,2,1,3
21.81,F1214,F,1,2,1,4
18.79,F1311,F,1,3,1,1
22.06,F1312,F,1,3,1,2
22.01,F1313,F,1,3,1,3
23.2,F1314,F,1,3,1,4
21.12,F2111,F,2,1,1,1
25.16,F2112,F,2,1,1,2
24.87,F2113,F,2,1,1,3
26.28,F2114,F,2,1,1,4
26.89,F2211,F,2,2,1,1
19.82,F2212,F,2,2,1,2
19.64,F2213,F,2,2,1,3
20.34,F2214,F,2,2,1,4
17.62,F2311,F,2,3,1,1
21.27,F2312,F,2,3,1,2
21.18,F2313,F,2,3,1,3
22.53,F2314,F,2,3,1,4
19.98,F3111,F,3,1,1,1
21.65,F3112,F,3,1,1,2
23.35,F3113,F,3,1,1,3
24.49,F3114,F,3,1,1,4
15.89,F3211,F,3,2,1,1
18.75,F3212,F,3,2,1,2
18.56,F3213,F,3,2,1,3
19.22,F3214,F,3,2,1,4
16.63,F3311,F,3,3,1,1
19.98,F3312,F,3,3,1,2
19.87,F3313,F,3,3,1,3
21.09,F3314,F,3,3,1,4
18.93,F4111,F,4,1,1,1
22.44,F4112,F,4,1,1,2
22.14,F4113,F,4,1,1,3
23.17,F4114,F,4,1,1,4
14.98,F4211,F,4,2,1,1
17.76,F4212,F,4,2,1,2
17.56,F4213,F,4,2,1,3
18.18,F4214,F,4,2,1,4
15.73,F4311,F,4,3,1,1
18.95,F4312,F,4,3,1,2
18.83,F4313,F,4,3,1,3
19.98,F4314,F,4,3,1,4
18.31,F1121,F,1,1,2,1
21.65,F1122,F,1,1,2,2
21.47,F1123,F,1,1,2,3
22.54,F1124,F,1,1,2,4
14.35,F1221,F,1,2,2,1
17.03,F1222,F,1,2,2,2
16.92,F1223,F,1,2,2,3
17.62,F1224,F,1,2,2,4
14.91,F1321,F,1,3,2,1
17.95,F1322,F,1,3,2,2
17.91,F1323,F,1,3,2,3
19.05,F1324,F,1,3,2,4
17.01,F2121,F,2,1,2,1
20.82,F2122,F,2,1,2,2
20.56,F2123,F,2,1,2,3
21.91,F2124,F,2,1,2,4
13.24,F2221,F,2,2,2,1
15.85,F2222,F,2,2,2,2
15.7,F2223,F,2,2,2,3
16.32,F2224,F,2,2,2,4
13.87,F2321,F,2,3,2,1
17.31,F2322,F,2,3,2,2
17.26,F2323,F,2,3,2,3
18.5,F2324,F,2,3,2,4
16,F3121,F,3,1,2,1
19.42,F3122,F,3,1,2,2
19.16,F3123,F,3,1,2,3
20.27,F3124,F,3,1,2,4
12.36,F3221,F,3,2,2,1
14.89,F3222,F,3,2,2,2
14.73,F3223,F,3,2,2,3
15.32,F3224,F,3,2,2,4
13,F3321,F,3,3,2,1
16.13,F3322,F,3,3,2,2
16.05,F3323,F,3,3,2,3
17.21,F3324,F,3,3,2,4
15.07,F4121,F,4,1,2,1
18.34,F4122,F,4,1,2,2
18.07,F4123,F,4,1,2,3
19.08,F4124,F,4,1,2,4
11.57,F4221,F,4,2,2,1
14.01,F4222,F,4,2,2,2
13.85,F4223,F,4,2,2,3
14.4,F4224,F,4,2,2,4
12.2,F4321,F,4,3,2,1
15.2,F4322,F,4,3,2,2
15.1,F4323,F,4,3,2,3
16.21,F4324,F,4,3,2,4
"""

df = pd.read_csv(StringIO(LIST_TSV), sep=",")
df.columns = df.columns.str.strip()
df["BP"]  = df["BP"].astype(int)
df["SM"]  = df["SM"].astype(int)
df["DM"]  = df["DM"].astype(int)
df["BMI"] = df["BMI"].astype(int)
df["sex"] = df["sex"].astype(str)

# ===============================
# ラベル辞書
# ===============================
BP_LABELS = {
    1: "正常",
    2: "正常高値/高値",
    3: "Ⅰ度高血圧",
    4: "Ⅱ/Ⅲ度高血圧"
}

SM_LABELS = {
    1: "喫煙していない",
    2: "過去に喫煙",
    3: "喫煙"
}

DM_LABELS = {
    1: "糖尿病でない",
    2: "糖尿病"
}

BMI_LABELS = {
    1: "やせ",
    2: "標準",
    3: "過体重",
    4: "肥満"
}

# ===============================
# 入力UI
# ===============================
st.subheader("基本情報")
sex = st.radio("性別", ["M", "F"], horizontal=True)

st.subheader("現在のリスク（Before）")
bp_b  = st.selectbox("血圧", options=list(BP_LABELS.keys()),
                     format_func=lambda x: f"{x}: {BP_LABELS[x]}", key="bp_b")
sm_b  = st.selectbox("喫煙", options=list(SM_LABELS.keys()),
                     format_func=lambda x: f"{x}: {SM_LABELS[x]}", key="sm_b")
dm_b  = st.selectbox("糖尿病", options=list(DM_LABELS.keys()),
                     format_func=lambda x: f"{x}: {DM_LABELS[x]}", key="dm_b")
bmi_b = st.selectbox("BMI", options=list(BMI_LABELS.keys()),
                     format_func=lambda x: f"{x}: {BMI_LABELS[x]}", key="bmi_b")

st.subheader("改善後のリスク（After）")
bp_a  = st.selectbox("血圧（改善後）", options=list(BP_LABELS.keys()),
                     format_func=lambda x: f"{x}: {BP_LABELS[x]}", key="bp_a")
sm_a  = st.selectbox("喫煙（改善後）", options=list(SM_LABELS.keys()),
                     format_func=lambda x: f"{x}: {SM_LABELS[x]}", key="sm_a")
dm_a  = st.selectbox("糖尿病（改善後）", options=list(DM_LABELS.keys()),
                     format_func=lambda x: f"{x}: {DM_LABELS[x]}", key="dm_a")
bmi_a = st.selectbox("BMI（改善後）", options=list(BMI_LABELS.keys()),
                     format_func=lambda x: f"{x}: {BMI_LABELS[x]}", key="bmi_a")

# ===============================
# 検索関数
# ===============================
def get_year(sex, bp, sm, dm, bmi):
    row = df[
        (df["sex"] == sex) &
        (df["BP"] == bp) &
        (df["SM"] == sm) &
        (df["DM"] == dm) &
        (df["BMI"] == bmi)
    ]
    if row.empty:
        return None
    return float(row.iloc[0]["year"])

# ===============================
# 計算・表示
# ===============================
if st.button("健康寿命を計算する"):
    year_before = get_year(sex, bp_b, sm_b, dm_b, bmi_b)
    year_after  = get_year(sex, bp_a, sm_a, dm_a, bmi_a)

    if year_before is None or year_after is None:
        st.error("指定された組み合わせが list.csv に存在しません")
    else:
        diff = year_after - year_before

        st.subheader("結果")
        st.metric("現在の健康寿命", f"{year_before:.2f} 年")
        st.metric("改善後の健康寿命", f"{year_after:.2f} 年",
                  delta=f"{diff:+.2f} 年")

        if diff > 0:
            st.success("生活習慣の改善により健康寿命が延びています")
        elif diff < 0:
            st.warning("リスクが悪化しています")
        else:
            st.info("健康寿命は変わりません")
